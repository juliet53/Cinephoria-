{% extends 'base.html.twig' %}

{% block title %}Réservation
{% endblock %}

{% block body %}
	<div class="container mt-5 bg-light p-4 rounded shadow" style="max-width: 1200px;">
		<h1 class="text-center mb-4">Réservation de Séance</h1>

		<!-- voir mes resa pour l'utilisateur co' -->
		{% if app.user %}
			<div class="mb-4">
				<a href="{{ path('app_user_reservations') }}" class="btn btn-primary">Voir mes réservations</a>
			</div>
		{% endif %}

		<!-- mes filtres !!!!!! -->
		<div class="mb-4">
			<div class="row">
				<div class="col-md-6 mb-3">
					<label for="filmFilter" class="form-label">Filtrer par film</label>
					<select id="filmFilter" class="form-select" onchange="updateSeanceDisplay()">
						<option value="">Tous les films</option>
						{% set seance_films = [] %}
						{% for seance in seances %}
							{% if seance.film.title not in seance_films %}
								{% set seance_films = seance_films|merge([seance.film.title]) %}
								<option value="{{ seance.film.title }}" {% if seance.film.title == filmFilter %} selected {% endif %}>{{ seance.film.title }}</option>
							{% endif %}
						{% endfor %}
					</select>
				</div>
				<div class="col-md-6 mb-3">
					<label for="dateFilter" class="form-label">Filtrer par date</label>
					<select id="dateFilter" class="form-select" onchange="updateSeanceDisplay()">
						<option value="">Toutes les dates</option>
						{% set dates = [] %}
						{% for seance in seances %}
							{% set date = seance.dateHeureDebut|date('Y-m-d') %}
							{% if date not in dates %}
								{% set dates = dates | merge([date]) %}
								<option value="{{ date }}" {% if date == dateFilter %} selected {% endif %}>{{ seance.dateHeureDebut|date('d/m/Y') }}</option>
							{% endif %}
						{% endfor %}
					</select>
				</div>
			</div>
		</div>

		<!-- les séances dispo ! -->
		{{ form_start(form, {'attr': {'id': 'reservationForm'}}) }}
		<div class="row mb-3">
			<div class="col-md-6">
				{{ form_row(form.numPersons, {'label': 'Nombre de personnes','attr': {'class': 'form-control', 'onchange': 'updateSeanceDisplay()'}}) }}
			</div>
		</div>

		<div class="row" id="seancesContainer">
			{% for seance in seances %}
				<div class="col-12 col-lg-4 mt-5 seance-card disabled" data-id="{{ seance.id }}" data-film="{{ seance.film.title }}" data-date="{{ seance.dateHeureDebut|date('Y-m-d') }}" data-places="{{ seance.getPlaceDisponible() }}" data-reserved-seats="{{ reservedSeatsBySeance[seance.id]|json_encode|e('html_attr') }}" onclick="toggleSelection(this)">
					<div class="card h-100 shadow-sm" style="cursor: pointer;">
						<div class="card-header text-dark">{{ seance.salle.cinema.ville }}</div>
						<div class="card-body">
							<h5 class="card-title">{{ seance.film.title }}</h5>
							<p class="card-text">
								<strong>Date :</strong> {{ seance.dateHeureDebut|date('d/m/Y H:i') }}<br>
								<strong>Qualité :</strong> {{ seance.qualite }}<br>
								<strong>Places non réservées :</strong>
								<span class="places-available badge bg-success">{{ seance.getPlaceDisponible() }}</span>
							</p>
						</div>
					</div>
				</div>
			{% else %}
				<div class="col-12 text-center">
					<p class="alert alert-warning">Aucune séance disponible</p>
				</div>
			{% endfor %}
		</div>

		{{ form_row(form.seance, {'attr': {'id': 'reservation_seance', 'class': 'd-none'}}) }}
		{{ form_row(form.seats, {'attr': {'id': 'reservation_seats', 'class': 'd-none'}}) }}

		<div class="mt-4 text-center">
			<h4>Places non réservées pour la séance sélectionnée : <span id="placesAvailableDisplay">0</span></h4>
		</div>

		<div id="seatSelection" class="mt-4 text-center"></div>

		<div class="text-center mt-4">
			<button type="submit" id="reserve_button" class="btn btn-primary btn-lg" style="display: none;">Réserver</button>
		</div>
		{{ form_end(form) }}
	</div>
{% endblock %}

{% block javascripts %}
<script src="{{ asset('js/reservation.js') }}"></script>
{% endblock %}
